<?php

declare(strict_types=1);

use PHPUnit\Framework\TestCase;
use WoltLab\WebpExif\Chunk\Exif;
use WoltLab\WebpExif\ChunkType;

final class ExifTest extends TestCase
{
    public function testReportsCorrectFourCC(): void
    {
        $chunk = Exif::forBytes(0, "");
        self::assertSame(
            ChunkType::EXIF,
            ChunkType::fromFourCC($chunk->getFourCC()),
        );
    }

    public function testReportsCorrectOffset(): void
    {
        // This is a bogus offset that cannot naturally occur because all chunks
        // in a RIFF contain must be of even length. We do not validate the
        // offset so this ensures we're not dealing with hardcoded values.
        $offset = 7;

        $chunk = Exif::forBytes($offset, "");
        self::assertSame(
            $offset,
            $chunk->getOffset(),
        );
    }

    public function testDecodesExifData(): void
    {
        $exifBytes = <<<BYTES
            \x49\x49\x2A\x00\x08\x00\x00\x00\x0B\x00\x0F\x01\x02\x00\x06\x00\x00\x00\x92\x00\x00\x00\x10\x01\x02\x00\x0E\x00\x00\x00\x98\x00\x00\x00\x12\x01\x03\x00\x01\x00\x00\x00\x01\x00\x00\x00\x1A\x01\x05\x00\x01\x00\x00\x00\xA6\x00\x00\x00\x1B\x01\x05\x00\x01\x00\x00\x00\xAE\x00\x00\x00\x28\x01\x03\x00\x01\x00\x00\x00\x02\x00\x00\x00\x31\x01\x02\x00\x0B\x00\x00\x00\xB6\x00\x00\x00\x32\x01\x02\x00\x14\x00\x00\x00\xC2\x00\x00\x00\x13\x02\x03\x00\x01\x00\x00\x00\x02\x00\x00\x00\x69\x87\x04\x00\x01\x00\x00\x00\xD6\x00\x00\x00\x25\x88\x04\x00\x01\x00\x00\x00\xD2\x03\x00\x00\xE4\x03\x00\x00\x43\x61\x6E\x6F\x6E\x00\x43\x61\x6E\x6F\x6E\x20\x45\x4F\x53\x20\x34\x30\x44\x00\x48\x00\x00\x00\x01\x00\x00\x00\x48\x00\x00\x00\x01\x00\x00\x00\x47\x49\x4D\x50\x20\x32\x2E\x34\x2E\x35\x00\x00\x32\x30\x30\x38\x3A\x30\x37\x3A\x33\x31\x20\x31\x30\x3A\x33\x38\x3A\x31\x31\x00\x1E\x00\x9A\x82\x05\x00\x01\x00\x00\x00\x44\x02\x00\x00\x9D\x82\x05\x00\x01\x00\x00\x00\x4C\x02\x00\x00\x22\x88\x03\x00\x01\x00\x00\x00\x01\x00\x00\x00\x27\x88\x03\x00\x01\x00\x00\x00\x64\x00\x00\x00\x00\x90\x07\x00\x04\x00\x00\x00\x30\x32\x32\x31\x03\x90\x02\x00\x14\x00\x00\x00\x54\x02\x00\x00\x04\x90\x02\x00\x14\x00\x00\x00\x68\x02\x00\x00\x01\x91\x07\x00\x04\x00\x00\x00\x01\x02\x03\x00\x01\x92\x0A\x00\x01\x00\x00\x00\x7C\x02\x00\x00\x02\x92\x05\x00\x01\x00\x00\x00\x84\x02\x00\x00\x04\x92\x0A\x00\x01\x00\x00\x00\x8C\x02\x00\x00\x07\x92\x03\x00\x01\x00\x00\x00\x05\x00\x00\x00\x09\x92\x03\x00\x01\x00\x00\x00\x09\x00\x00\x00\x0A\x92\x05\x00\x01\x00\x00\x00\x94\x02\x00\x00\x86\x92\x07\x00\x08\x01\x00\x00\x9C\x02\x00\x00\x90\x92\x02\x00\x03\x00\x00\x00\x30\x30\x00\x00\x91\x92\x02\x00\x03\x00\x00\x00\x30\x30\x00\x00\x92\x92\x02\x00\x03\x00\x00\x00\x30\x30\x00\x00\x00\xA0\x07\x00\x04\x00\x00\x00\x30\x31\x30\x30\x01\xA0\x03\x00\x01\x00\x00\x00\x01\x00\x00\x00\x02\xA0\x04\x00\x01\x00\x00\x00\x64\x00\x00\x00\x03\xA0\x04\x00\x01\x00\x00\x00\x44\x00\x00\x00\x05\xA0\x04\x00\x01\x00\x00\x00\xB4\x03\x00\x00\x0E\xA2\x05\x00\x01\x00\x00\x00\xA4\x03\x00\x00\x0F\xA2\x05\x00\x01\x00\x00\x00\xAC\x03\x00\x00\x10\xA2\x03\x00\x01\x00\x00\x00\x02\x00\x00\x00\x01\xA4\x03\x00\x01\x00\x00\x00\x00\x00\x00\x00\x02\xA4\x03\x00\x01\x00\x00\x00\x01\x00\x00\x00\x03\xA4\x03\x00\x01\x00\x00\x00\x00\x00\x00\x00\x06\xA4\x03\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\xA0\x00\x00\x00\x47\x00\x00\x00\x0A\x00\x00\x00\x32\x30\x30\x38\x3A\x30\x35\x3A\x33\x30\x20\x31\x35\x3A\x35\x36\x3A\x30\x31\x00\x32\x30\x30\x38\x3A\x30\x35\x3A\x33\x30\x20\x31\x35\x3A\x35\x36\x3A\x30\x31\x00\x00\x60\x07\x00\x00\x00\x01\x00\x00\xA0\x05\x00\x00\x00\x01\x00\x00\x00\x00\x00\x01\x00\x00\x00\x87\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x53\x3B\x00\x6C\x03\x00\x00\x00\x8D\x27\x00\x47\x02\x00\x00\x02\x00\x01\x00\x02\x00\x04\x00\x00\x00\x52\x39\x38\x00\x02\x00\x07\x00\x04\x00\x00\x00\x30\x31\x30\x30\x00\x00\x00\x00\x01\x00\x00\x00\x01\x00\x04\x00\x00\x00\x02\x02\x00\x00\x00\x00\x00\x00\x06\x00\x03\x01\x03\x00\x01\x00\x00\x00\x06\x00\x00\x00\x1A\x01\x05\x00\x01\x00\x00\x00\x32\x04\x00\x00\x1B\x01\x05\x00\x01\x00\x00\x00\x3A\x04\x00\x00\x28\x01\x03\x00\x01\x00\x00\x00\x02\x00\x00\x00\x01\x02\x04\x00\x01\x00\x00\x00\x42\x04\x00\x00\x02\x02\x04\x00\x01\x00\x00\x00\x62\x05\x00\x00\x00\x00\x00\x00\x48\x00\x00\x00\x01\x00\x00\x00\x48\x00\x00\x00\x01\x00\x00\x00\xFF\xD8\xFF\xE0\x00\x10\x4A\x46\x49\x46\x00\x01\x01\x00\x00\x01\x00\x01\x00\x00\xFF\xDB\x00\x43\x00\x0B\x08\x08\x0A\x08\x07\x0B\x0A\x09\x0A\x0D\x0C\x0B\x0D\x11\x1C\x12\x11\x0F\x0F\x11\x22\x19\x1A\x14\x1C\x29\x24\x2B\x2A\x28\x24\x27\x27\x2D\x32\x40\x37\x2D\x30\x3D\x30\x27\x27\x38\x4C\x39\x3D\x43\x45\x48\x49\x48\x2B\x36\x4F\x55\x4E\x46\x54\x40\x47\x48\x45\xFF\xDB\x00\x43\x01\x0C\x0D\x0D\x11\x0F\x11\x21\x12\x12\x21\x45\x2E\x27\x2E\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\x45\xFF\xC0\x00\x11\x08\x00\x2E\x00\x44\x03\x01\x22\x00\x02\x11\x01\x03\x11\x01\xFF\xC4\x00\x1F\x00\x00\x01\x05\x01\x01\x01\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\xFF\xC4\x00\xB5\x10\x00\x02\x01\x03\x03\x02\x04\x03\x05\x05\x04\x04\x00\x00\x01\x7D\x01\x02\x03\x00\x04\x11\x05\x12\x21\x31\x41\x06\x13\x51\x61\x07\x22\x71\x14\x32\x81\x91\xA1\x08\x23\x42\xB1\xC1\x15\x52\xD1\xF0\x24\x33\x62\x72\x82\x09\x0A\x16\x17\x18\x19\x1A\x25\x26\x27\x28\x29\x2A\x34\x35\x36\x37\x38\x39\x3A\x43\x44\x45\x46\x47\x48\x49\x4A\x53\x54\x55\x56\x57\x58\x59\x5A\x63\x64\x65\x66\x67\x68\x69\x6A\x73\x74\x75\x76\x77\x78\x79\x7A\x83\x84\x85\x86\x87\x88\x89\x8A\x92\x93\x94\x95\x96\x97\x98\x99\x9A\xA2\xA3\xA4\xA5\xA6\xA7\xA8\xA9\xAA\xB2\xB3\xB4\xB5\xB6\xB7\xB8\xB9\xBA\xC2\xC3\xC4\xC5\xC6\xC7\xC8\xC9\xCA\xD2\xD3\xD4\xD5\xD6\xD7\xD8\xD9\xDA\xE1\xE2\xE3\xE4\xE5\xE6\xE7\xE8\xE9\xEA\xF1\xF2\xF3\xF4\xF5\xF6\xF7\xF8\xF9\xFA\xFF\xC4\x00\x1F\x01\x00\x03\x01\x01\x01\x01\x01\x01\x01\x01\x01\x00\x00\x00\x00\x00\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\xFF\xC4\x00\xB5\x11\x00\x02\x01\x02\x04\x04\x03\x04\x07\x05\x04\x04\x00\x01\x02\x77\x00\x01\x02\x03\x11\x04\x05\x21\x31\x06\x12\x41\x51\x07\x61\x71\x13\x22\x32\x81\x08\x14\x42\x91\xA1\xB1\xC1\x09\x23\x33\x52\xF0\x15\x62\x72\xD1\x0A\x16\x24\x34\xE1\x25\xF1\x17\x18\x19\x1A\x26\x27\x28\x29\x2A\x35\x36\x37\x38\x39\x3A\x43\x44\x45\x46\x47\x48\x49\x4A\x53\x54\x55\x56\x57\x58\x59\x5A\x63\x64\x65\x66\x67\x68\x69\x6A\x73\x74\x75\x76\x77\x78\x79\x7A\x82\x83\x84\x85\x86\x87\x88\x89\x8A\x92\x93\x94\x95\x96\x97\x98\x99\x9A\xA2\xA3\xA4\xA5\xA6\xA7\xA8\xA9\xAA\xB2\xB3\xB4\xB5\xB6\xB7\xB8\xB9\xBA\xC2\xC3\xC4\xC5\xC6\xC7\xC8\xC9\xCA\xD2\xD3\xD4\xD5\xD6\xD7\xD8\xD9\xDA\xE2\xE3\xE4\xE5\xE6\xE7\xE8\xE9\xEA\xF2\xF3\xF4\xF5\xF6\xF7\xF8\xF9\xFA\xFF\xDA\x00\x0C\x03\x01\x00\x02\x11\x03\x11\x00\x3F\x00\xE1\x6F\x25\x37\x65\xEE\x19\x46\x0E\x06\xDC\xFB\x75\xAA\xB6\xE0\xB4\x82\x37\x6F\x29\x18\xF2\x7A\xD6\x98\xD1\x41\x94\x2A\xEA\x16\xF2\xEE\x1F\xC2\xC4\x11\xF8\x1A\xAF\x3D\x8C\xF6\x17\x48\x92\xB0\x31\xAF\x3B\xC0\xC8\xAE\x48\xCA\x2F\x44\x53\x4D\xB2\xD2\x4A\x64\xD3\x26\xB7\x39\x30\xC6\xC1\x81\xFE\xE8\xCF\x5A\xA9\x6A\xF0\xB2\xCB\x0C\x8B\x85\x23\x28\x4F\x50\x6B\x6B\x4B\x92\x53\x1C\xE5\x55\x19\x26\x1B\x5C\x30\xE1\x85\x27\xD9\x63\x32\x6C\x48\xD7\x3E\xB8\xE8\x6A\xA3\x16\x0D\x1C\xF7\x96\xC9\x95\x11\xB1\xC9\xE3\x02\x90\x59\xBC\x92\xAA\x94\x2A\x09\xEE\x3A\x57\x4B\x1D\xA0\x46\x63\xB0\x96\x5E\x7A\x71\x53\x88\x0C\x92\xBA\xCB\x02\xF9\x43\xA6\xD5\xC1\x02\xAD\xE8\x16\x39\x5D\x4D\x84\xAE\x24\x40\xE3\xCA\x3E\x52\x82\xB8\x5D\xA2\xAA\xAB\x27\x94\x09\x5C\xB0\x3C\x03\x5D\xCA\xDA\x43\x0A\xB6\xF8\x41\x56\x04\x6D\x6E\x7A\xE3\xFC\xFE\x35\xC5\x5F\x79\x4B\x7B\x38\x81\x70\xBB\xCE\x31\xFC\x22\x84\x92\x56\x42\x68\x88\x44\x58\x65\x88\xC9\xF7\xA2\x9C\xAA\x02\xF5\xA2\x8D\x42\xCC\xBF\x77\x6F\x75\x34\xEC\xD2\x40\xC1\xCE\x00\x0A\x3B\x7B\x55\xAB\x7B\x19\x5C\xA1\xD4\x2E\x1B\x6A\x8F\x95\x19\x89\x38\xF6\xAB\xD3\x5F\x3C\x92\x29\xB7\x4F\x2D\xDC\x81\x8C\x64\xE7\xEB\x4E\x92\xDD\xE5\x62\xEE\xD8\x27\x86\x6E\xBF\xE7\xA5\x24\x68\xD8\xF8\x2E\x02\xA1\x89\x7E\x55\x53\x8D\xA2\xAD\x69\x90\xF9\xCF\x21\x6F\xBA\x06\x49\x1D\x7D\xAA\x93\x29\x07\xCB\x51\xB3\x19\xC8\x20\x8A\xD7\xB5\x31\xDB\xD9\xA1\x60\x4B\x33\x60\x05\xCE\x49\xFA\x0A\xA7\xB5\x91\x9F\x5B\xB2\x74\xB2\x59\x17\x74\x5F\x78\x70\xC7\xAE\x3F\xCE\x2A\x44\x88\x2C\x64\x4C\xC7\x8E\x4E\xD1\x4E\x6B\xE6\x56\xFB\x3F\x28\x48\xCE\xC0\x9B\x4B\x0F\x50\x08\xE6\xA8\xDF\x6A\x10\xC1\x66\xD7\x0E\xCA\x40\x18\x42\x41\xE7\xD3\xDE\xB3\x71\x65\x73\x5F\x62\xBE\xA7\xA9\xC1\x6E\x8D\xB4\x6D\x38\xE0\x91\x93\xEC\x4F\x39\xC6\x71\xD2\xB8\xC9\xA3\xCC\xAC\xFB\x42\xEF\x24\xF1\x4F\x9E\xEE\x5D\x42\x57\x72\x0E\xCD\xC7\x1E\xA0\x7F\x9C\x56\x92\x59\xD9\x2C\x11\x81\x2B\xEF\x3C\x31\x61\xD3\xE9\x55\x75\x1D\x0A\x8C\x6E\x67\xC1\x66\xF2\xA1\x65\x0C\x46\x71\xD2\x8A\xDD\xFB\x22\x27\x10\xDF\xA0\x4E\xC0\x8C\x51\x53\xCE\x69\xC8\x41\x69\x34\x6D\x7F\x10\x73\xC1\x27\xAF\x73\x8E\x2B\x52\x6D\x42\x38\x4E\x76\xF2\x46\x32\xBD\xBF\x0A\xE6\xE4\x8C\x89\xD3\x0D\xFC\x43\x1E\xDC\xD6\x9F\x0E\xD9\x22\xA9\xAD\x51\x88\xEB\x8B\xD5\x97\x77\x92\xE1\x64\xC7\x00\xF1\x9A\x73\xEA\x77\x29\x0C\x72\x79\x49\x1A\x21\x0C\x24\x07\xBF\x70\x47\xE6\x2A\x09\x60\x47\x0C\x19\x54\x80\x33\x54\xCC\xA4\xDA\x88\x49\x2C\x9B\xBB\xD5\xD8\x4C\xBE\x35\x33\x79\x14\x6B\xF3\x2F\x94\xE5\xD4\xAF\x55\xC8\xED\xE8\x2A\xF5\xF3\x14\xD3\xA3\x46\x89\x65\x37\x19\x0A\x5F\xA7\x15\x9F\x6B\x0A\xAA\xA0\x03\xEF\xB9\xDD\xF4\x15\xB9\x63\x6B\x0E\xB3\xA0\x2C\x6C\x19\x2E\xA1\xB9\x23\x79\x39\x1C\x83\xFE\x15\x94\xE7\xCA\x69\x18\xDC\xCC\x87\x4A\x86\x3B\x34\x32\x04\xF3\x09\xFE\x1E\xA2\xA4\x5D\x0A\x1F\xB3\x19\x4C\xB8\x20\xE1\x94\x9E\x86\xAF\x45\x67\x65\x67\x6D\x34\xEE\x92\x49\x3C\x43\x61\xCB\x65\x72\x78\xC8\x15\x8E\x0B\x8B\x69\x04\x33\x3A\x80\x09\xCB\x01\x9A\x84\xD3\xD8\xD1\xA6\x8D\x2B\x6D\x1B\x4E\x68\x41\x9E\xE2\x54\x7F\x4E\x28\xAE\x60\xCD\x73\x93\xFB\xDC\xFD\x68\xAB\xE5\x7D\xC9\xE6\x3F\xFF\xD9
            BYTES;

        $chunk = Exif::forBytes(0, $exifBytes);
        $parsedExif = $chunk->getParsedExif();

        self::assertNotNull($parsedExif);

        self::assertArrayHasKey('Model', $parsedExif);
        self::assertEquals($parsedExif['Model'], 'Canon EOS 40D');
    }

    public function testEmptyExifReturnsNull(): void
    {
        $chunk = Exif::forBytes(0, "");
        $parsedExif = $chunk->getParsedExif();
        self::assertNull($parsedExif);
    }
}
